<div #readerContainer class="reader-container"
     (click)="onWrapperClick($event)"
     (touchstart)="onTouchStart($event)"
     (touchmove)="onTouchMove($event)"
     (touchend)="onTouchEnd($event)"
     (touchcancel)="onTouchCancel($event)">

  <!-- Loading and Error States -->
  <div *ngIf="isLoading" class="loading-indicator">Loading book...</div>
  <div *ngIf="errorMessage && !isLoading" class="error-message">{{ errorMessage }}</div>

  <!-- Wrapper for Native Scroll -->
  <div #readerContentWrapper
       class="reader-content-wrapper"
       (scroll)="onWrapperScroll($event)"
       *ngIf="!isLoading && !errorMessage">

    <div #readerContent
         class="reader-content"
         [innerHTML]="bookHtmlContent | safeHtml">
    </div>
  </div>

  <!-- Pagination/Navigation Controls -->
  <div #paginationControls *ngIf="!isLoading && !errorMessage" class="pagination-controls">
    <div class="pagination-center-area">
      <div class="chapter-nav-container" *ngIf="chapterNav.length > 0">
        <lucide-icon
          #tocDropdown="tuiDropdown"
          (click)="tocDropdown.toggle(true)"
          (tuiActiveZoneChange)="!$event && tocDropdown.toggle(false)"
          [tuiDropdown]="tocDropdownContent"
          name="table-of-contents"
          size="26"
          strokeWidth="1.75"
          title="Table of Contents"
          tuiDropdown
        >
        </lucide-icon>

        <!-- Dropdown Content Template -->
        <ng-template #tocDropdownContent>
          <!-- Use tuiDataList for standard Taiga dropdown items -->
          <tui-data-list role="menu">
            <button
              (click)="jumpToChapter(chapter.elementId)"
              *ngFor="let chapter of chapterNav"
              role="menuitem"
              tuiOption
            >
              <!-- Display title -->
              {{ chapter.title | slice:0:40 }}{{ chapter.title.length > 40 ? '...' : '' }}
            </button>
          </tui-data-list>
        </ng-template>

      </div>
      <!-- Previous Button -->
      <app-button
        appearance="text"
        (mousedown)="startScrollHold('prev')"
        (touchstart)="startScrollHold('prev'); $event.preventDefault()"
        (mouseup)="stopScrollHold('prev')"
        (touchend)="stopScrollHold('prev')"
        (mouseleave)="clearScrollHoldTimers()"
        (touchcancel)="clearScrollHoldTimers()"
        title="Previous Page (Click) / Scroll Up (Hold)">
        <lucide-icon name="circle-chevron-left" size="28" strokeWidth="1.5"></lucide-icon>
      </app-button>

      <!-- Slider (Percentage) & Chapter Select -->
      <div class="slider-chapter-area">
        <!-- Percentage Slider -->
        <input type="range"
               class="page-slider"
               tuiSlider
               [min]="0"
               [max]="100"
               [ngModel]="currentScrollPercentage"
               (input)="onSliderInput($event)"
               aria-label="Scroll Position Slider"/>
        <!-- Percentage Display -->
        <span class="pagination-info">{{ currentScrollPercentage }}%</span>
      </div>

      <!-- Next Button -->
      <app-button
        appearance="text"
        (mousedown)="startScrollHold('next')"
        (touchstart)="startScrollHold('next'); $event.preventDefault()"
        (mouseup)="stopScrollHold('next')"
        (touchend)="stopScrollHold('next')"
        (mouseleave)="clearScrollHoldTimers()"
        (touchcancel)="clearScrollHoldTimers()"
        title="Next Page (Click) / Scroll Down (Hold)">
        <lucide-icon name="circle-chevron-right" size="28" strokeWidth="1.5"></lucide-icon>
      </app-button>

      <!-- Parallel Text Controls (Placeholder) -->
      <div *ngIf="parallelVersions.length > 0" class="parallel">
        Parallel:
        <tui-select
          tuiTextfieldSize="s"
          class="language-select"
          [formControl]="languageSelectControl"
          [tuiTextfieldLabelOutside]="true">
          <tui-data-list-wrapper *tuiDataList [items]="langs"></tui-data-list-wrapper>
        </tui-select>
      </div>

    </div> <!-- End pagination-center-area -->
  </div> <!-- End pagination-controls -->
</div> <!-- End readerContainer -->
