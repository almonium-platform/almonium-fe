<tui-drawer
  *tuiPopup="requestsTabOpened()"
  direction="left"
  class="drawer"
  [overlay]="true"
  (click.self)="closeRequestsTab()"
>
  <ng-template #skeletonLoader>
    <div class="user-tile card h-14" [tuiSkeleton]="true"></div>
  </ng-template>

  <header class="header">
    <div class="header-inner pb-1">
      <p class="header-text">Requests</p>
      <app-dismiss-button [relative]="true" (close)="closeRequestsTab()"></app-dismiss-button>
    </div>
  </header>
  <div class="requests">
    <tui-segmented
      size="l"
      class="requests-toggle"
      [(activeItemIndex)]="requestsIndex"
    >
      <button type="button" class="btn-text">Received</button>
      <button type="button" class="btn-text">Sent</button>
    </tui-segmented>
    <tui-scrollbar class="w-full p-1">
      <div class="tiles">
        @if (requestsIndex === 0) {
          @if (loadingIncomingRequests) {
            @for (i of range(3); track i) {
              <ng-container [ngTemplateOutlet]="skeletonLoader"
                            [ngTemplateOutletContext]="{ count: 3 }"></ng-container>
            }
          } @else {
            @for (friend of incomingRequests; track friend) {
              <div class="user-tile card">
                <app-avatar [avatarUrl]="friend.avatarUrl"
                            [username]="friend.username"
                            [size]="'m'"
                ></app-avatar>
                <p class="username">{{ friend.username }}</p>

                @if (friend.friendshipStatus === FriendshipStatus.PENDING) {
                  <lucide-icon name="user-round-plus"
                               class="friend-action positive"
                               [size]="20"
                               (click)="acceptFriendRequest(friend)"
                  ></lucide-icon>
                  <lucide-icon name="x"
                               class="friend-action negative secondary"
                               [size]="20"
                               (click)="rejectFriendRequest(friend.friendshipId)"
                  ></lucide-icon>
                }

                @if (friend.friendshipStatus === FriendshipStatus.FRIENDS) {
                  <lucide-icon name="message-circle"
                               class="friend-action positive"
                               [size]="20"
                               (click)="openChatWithNewFriend(friend.id)"
                  ></lucide-icon>
                }
              </div>
            }
          }
        }

        @if (requestsIndex === 1) {
          @if (loadingOutgoingRequests) {
            @for (i of range(3); track i) {
              <ng-container [ngTemplateOutlet]="skeletonLoader"
                            [ngTemplateOutletContext]="{ count: 3 }"></ng-container>
            }
          } @else {
            @for (friend of outgoingRequests; track friend) {
              <div class="user-tile card">
                <app-avatar [avatarUrl]="friend.avatarUrl"
                            [username]="friend.username"
                            [size]="'m'"
                ></app-avatar>
                <p class="username">{{ friend.username }}</p>
                <lucide-icon name="x"
                             class="friend-action negative"
                             [size]="20"
                             (click)="cancelFriendRequest(friend.friendshipId)"
                ></lucide-icon>
              </div>
            }
          }
        }
      </div>
    </tui-scrollbar>
  </div>
</tui-drawer>

<div class="super-container">
  <div class="left-container">
    <div class="chats-container">
      <header class="chats-header">
        <lucide-icon name="menu"
                     class="cursor-pointer"
                     (click)="openRequestsTab()"
        ></lucide-icon>

        <p class="header-text">Chats</p>
      </header>
      <tui-input
        [formControl]="chatFormControl"
        [tuiTextfieldLabelOutside]="true"
        class="friend-input shadowless-input"
      >
        Search
        <input
          tuiTextfieldLegacy
          type="text"
          (keydown.enter)="searchNewUsers()"
        />
      </tui-input>
      <div class="channel-list">
        <stream-channel-list>
          <ng-template
            #channelPreview
            let-channelDisplayTitle="channelDisplayTitle"
            let-channel="channel"
            let-unreadCount="unreadCount"
            let-latestMessageText="latestMessageText"
            let-latestMessageStatus="latestMessageStatus"
            let-latestMessageTime="latestMessageTime"
          >
            <div class="str-chat__channel-preview-end-first-row">
              <div class="str-chat__channel-preview-messenger--name">
                <span data-testid="channel-preview-title">
                {{ getChatName(channel, channelDisplayTitle) }}
              </span>
              </div>
              <div
                *ngIf="unreadCount"
                data-testid="unread-badge"
                class="str-chat__channel-preview-unread-badge"
              >
                {{ unreadCount }}
              </div>
            </div>
            <div class="str-chat__channel-preview-end-second-row">
              <div
                data-testid="latest-message"
                class="str-chat__channel-preview-messenger--last-message"
              >
                <ng-container *ngIf="displayAs === 'text'; else asHTML">
                  {{ latestMessageText | translate }}
                </ng-container>
                <ng-template #asHTML>
            <span
              data-testid="html-content"
              [innerHTML]="latestMessageText | translate"
            ></span>
                </ng-template>
              </div>
              <div
                *ngIf="latestMessageStatus"
                data-testid="latest-message-status"
                class="str-chat__channel-preview-messenger--status str-chat__channel-preview-messenger--status-{{
            latestMessageStatus
          }}"
              >
                <stream-icon-placeholder
                  [icon]="latestMessageStatus === 'delivered' ? 'delivered' : 'read'"
                ></stream-icon-placeholder>
              </div>
              <div
                *ngIf="latestMessageTime"
                data-testid="latest-message-time"
                class="str-chat__channel-preview-messenger--time"
              >
                {{ latestMessageTime }}
              </div>
            </div>
          </ng-template>
        </stream-channel-list>
      </div>

      <!-- Show matched friends when searching -->
      @if (!isNotFiltered() && matchedFriends.length > 0) {
        <div class="matched-friends-container">
          @for (friend of matchedFriends; track friend) {
            <div class="chat-tile"
                 (click)="sendFriendRequest(friend.id)"
            >
              <app-avatar [avatarUrl]="friend.avatarUrl"
                          [username]="friend.username"
                          [size]="'m'">
              </app-avatar>
              <p class="username">{{ friend.username }}</p>
            </div>
          }
        </div>
      }

      <!-- Show message when no friends exist initially -->
      @if (friends.length === 0 && isNotFiltered()) {
        <div class="no-friends-container">
          You have no friends yet.
        </div>
      }

      <!-- Show message when no matches found after searching -->
      @if (!isNotFiltered() && nothingFound) {
        <div class="no-matches-container">
          <p class="no-matches-text">No matches found.</p>
        </div>
      }
    </div>
  </div>

  <div class="right-container">
    <div class="chat-window">
      <stream-channel>
        <ng-template #customHeaderTemplate let-channel="channel">
          <app-chat-header [channel]="channel"></app-chat-header>
        </ng-template>

        <stream-channel-header></stream-channel-header>
        <stream-message-list></stream-message-list>
        <stream-notification-list></stream-notification-list>
        <stream-message-input></stream-message-input>
      </stream-channel>
    </div>
    @if (false) {
      <div class="search-container">
        <tui-input
          [formControl]="usernameFormControl"
          [tuiTextfieldLabelOutside]="true"
          class="username-input"
          tuiTextfieldIconLeft="@tui.user-search"
        >
          Type a username
          <input
            tuiTextfieldLegacy
            type="text"
            (keydown.enter)="searchNewUsers()"
          />
        </tui-input>
        <div class="tiles">
          @for (friend of matchedUsers; track friend) {
            <div class="user-tile card">
              <app-avatar [avatarUrl]="friend.avatarUrl"
                          [username]="friend.username"
                          [size]="'m'"
              ></app-avatar>
              <p class="username">{{ friend.username }}</p>
              <lucide-icon [name]="requestedIds.includes(friend.id) ? 'bell' : 'user-round-plus'"
                           class="friend-action"
                           (click)="sendFriendRequest(friend.id)"
                           [ngClass]="{ 'motion-preset-shake': requestedIds.includes(friend.id) }"
                           [size]="20"
              ></lucide-icon>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
